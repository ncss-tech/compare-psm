}
cbind(summary(r.sg.05),
summary(r.sg.50),
summary(r.sg.95))
(dest.dir.sg <-  file.path(base.dir.sg,
AOI.dir.prefix,
voi))
## Q0.05
(file.sg <- paste0(dest.dir.sg, "/Q0.05/", depth, "/", voi_layer_05, '_4326.tif'))
if (file.exists(file.sg)) {
r.sg.05 <- terra::rast(file.sg)
} else {
print("No SoilGrids250 Q0.05 tile"); stop("Missing input file")
}
## Q0.5
(file.sg <- paste0(dest.dir.sg, "/Q0.5/", depth, "/", voi_layer_50, '_4326.tif'))
if (file.exists(file.sg)) {
r.sg.50 <- terra::rast(file.sg)
} else {
print("No SoilGrids250 Q0.5 tile"); stop("Missing input file")
}
## Q0.95
(file.sg <- paste0(dest.dir.sg, "/Q0.95/", depth, "/", voi_layer_95, '_4326.tif'))
if (file.exists(file.sg)) {
r.sg.95 <- terra::rast(file.sg)
} else {
print("No SoilGrids250 Q0.95 tile"); stop("Missing input file")
}
(cbind(summary(r.sg.05), summary(r.sg.50), summary(r.sg.95)))
zlim = c(floor(min(values(r.sg.05), na.rm=TRUE)),
ceiling(max(values(r.sg.95), na.rm=TRUE)))
par(mfrow=c(1,3))
terra::plot(r.sg.05, col=rev(heat.colors(64)),
main=paste0("Q05, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.50, col=rev(heat.colors(64)),
main=paste0("Q50, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.95, col=rev(heat.colors(64)),
main=paste0("Q95, SoilGrids250, ",
voi, ", ", depth), range=zlim)
par(mfrow=c(1,1))
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.list.polaris[voi], "/p5/",
depth.list.polaris[depth], "/",
AOI.dir.prefix, ".tif"))
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.list.polaris[voi], "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
voi <- "phh2o"   # variable of interest, SoilGrids name
depth <- "0-5cm" # "0-5cm", "5-15cm", "15-30cm", "30-60cm", "60-100cm", "100-200cm"
voi_layer_05 <- paste(voi, depth, "Q0.05", sep="_") # layer of interest, 5%
voi_layer_50 <- paste(voi, depth, "Q0.5", sep="_") # layer of interest, 50%
voi_layer_95 <- paste(voi, depth, "Q0.95", sep="_") # layer of interest, 95%
voi.polaris <- voi.list.polaris[match(voi, voi.list)]
depth.polaris <- gsub( "-", "_", strsplit(depth, "cm")[[1]])
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.list.polaris[voi], "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.list.polaris[voi], "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.50 <- terra::rast(file.name)
names(r.p) <- "p50"
print(r.p)
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.50 <- terra::rast(file.name)
names(r.p) <- "p50"
print(r.p)
}
print(r.p.50)
?aggregate
res(r.p.50)
res(r.sg.50)
(aggregation.factor <- res(r.sg.50)/res(r.p.50))
250/30
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r <- terra::rast(file.name)
names(r) <- "p50"
r.p.50 <- terra::aggregate(r, fact=250/30)
print(r.p.50)
} else {
print("No POLARIS p50 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r <- terra::rast(file.name)
names(r) <- "p50"
} else {
print("No POLARIS p50 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.50 <- terra::rast(file.name)
names(r) <- "p50"
} else {
print("No POLARIS p50 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.5 <- terra::rast(file.name)
names(r) <- "p5"
} else {
print("No POLARIS p5 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p50/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.50 <- terra::rast(file.name)
names(r) <- "p50"
} else {
print("No POLARIS p50 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p95/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.95 <- terra::rast(file.name)
names(r) <- "p95"
} else {
print("No POLARIS p95 tile"); stop("Missing input file")
}
(aggregation.factor <- res(r.sg.50)/res(r.p.50))
r.p.5.a <- terra::aggregate(r.p.5, fact=aggregation.factor, fun="mean")
plot(r.p.5.a)
aggregation.factor <- 8
r.p.5.a <- terra::aggregate(r.p.5, fact=aggregation.factor, fun="mean")
plot(r.p.5.a)
r.p.5 <- terra::aggregate(r.p.5, fact=aggregation.factor, fun="mean")
r.p.05 <- mask(r.p.5, r.sg.05)
r.p.50 <- mask(r.p.50, r.sg.50)
r <- mask(r.sg.05, r.p.5)
?resample
summary(r.sg.05)
r <- terra::resample(r.sg.05, r.p.5, method="near")
summary(r)
plot(r)
r.sg.05 <- terra::resample(r.sg.05, r.p.5, method="near")
r.sg.50 <- terra::resample(r.sg.55, r.p.5, method="near")
r.sg.95 <- terra::resample(r.sg.95, r.p.5, method="near")
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center', fig.path = './figs/uncert_sg_polaris/')
knitr::opts_chunk$set(cache.extra = R.version.string)
# Chunk 2
quantile.list <- c("Q0.05", "Q0.5", "Q0.95")
quantile.list.polaris <- c("p5", "p5", "p95")
# Chunk 3
voi.list <- c("bdod", "clay", "phh2o", "sand", "silt", "soc")
voi.list.polaris <- c("bd", "clay", "ph", "sand", "silt", "om")
# Chunk 4
depth.list <- c("0-5", "5-15", "15-30", "30-60", "60-100", "100-200")
# Chunk 5
df <- data.frame(voi.list,
c("cg/cm3","g/kg","pHx10","g/kg","g/kg","dg/kg"),
c("g/cm3","%","pH","%","%","log10(%)"),
c(100, 10, 10, 10, 10, "10^,0.58,1000"))
knitr::kable(
df, caption = 'Properties and units of measure',
col.names=c("Property","SoilGrids","POLARIS","factor"),
booktabs = TRUE)
# Chunk 6
library(rgdal)
library(terra)
library(sf)
# Chunk 7
base.dir <- "/Users/rossiter/ds/"
base.dir.sg <- paste0(base.dir, "SoilGrids250")
base.dir.polaris <- paste0(base.dir, "POLARIS")
base.dir.import <- "/Volumes/Pythagoras/ds/"
base.dir.polaris.import <- paste0(base.dir.import, "POLARIS")
# Chunk 8
voi <- "phh2o"   # variable of interest, SoilGrids name
depth <- "0-5cm" # "0-5cm", "5-15cm", "15-30cm", "30-60cm", "60-100cm", "100-200cm"
voi_layer_05 <- paste(voi, depth, "Q0.05", sep="_") # layer of interest, 5%
voi_layer_50 <- paste(voi, depth, "Q0.5", sep="_") # layer of interest, 50%
voi_layer_95 <- paste(voi, depth, "Q0.95", sep="_") # layer of interest, 95%
voi.polaris <- voi.list.polaris[match(voi, voi.list)]
depth.polaris <- gsub( "-", "_", strsplit(depth, "cm")[[1]])
# Chunk 9
tile.lrc <- c(-76, 42) # lower-right corner: central NY
# tile.lrc <- c(-77, 35)   # lower-right corner: coastal plain NC
tile.ulc <- c(tile.lrc[1]-1, tile.lrc[2]+1) # upper-left corner
m <- matrix(c(tile.ulc[1],tile.lrc[1],  #ulc
tile.ulc[2], tile.lrc[2]  #lrc
),
nrow=2)
bb.ll <- st_sfc(st_multipoint(m))
st_crs(bb.ll) <- 4326
# Chunk 10
AOI.dir.prefix <- paste0("lat", tile.lrc[2], tile.ulc[2],
"_lon", tile.ulc[1], tile.lrc[1])
# Chunk 11
(dest.dir.sg <-  file.path(base.dir.sg,
AOI.dir.prefix,
voi))
## Q0.05
(file.sg <- paste0(dest.dir.sg, "/Q0.05/", depth, "/", voi_layer_05, '_4326.tif'))
if (file.exists(file.sg)) {
r.sg.05 <- terra::rast(file.sg)
} else {
print("No SoilGrids250 Q0.05 tile"); stop("Missing input file")
}
## Q0.5
(file.sg <- paste0(dest.dir.sg, "/Q0.5/", depth, "/", voi_layer_50, '_4326.tif'))
if (file.exists(file.sg)) {
r.sg.50 <- terra::rast(file.sg)
} else {
print("No SoilGrids250 Q0.5 tile"); stop("Missing input file")
}
## Q0.95
(file.sg <- paste0(dest.dir.sg, "/Q0.95/", depth, "/", voi_layer_95, '_4326.tif'))
if (file.exists(file.sg)) {
r.sg.95 <- terra::rast(file.sg)
} else {
print("No SoilGrids250 Q0.95 tile"); stop("Missing input file")
}
(cbind(summary(r.sg.05), summary(r.sg.50), summary(r.sg.95)))
# Chunk 12: display.quantiles.sg
zlim = c(floor(min(values(r.sg.05), na.rm=TRUE)),
ceiling(max(values(r.sg.95), na.rm=TRUE)))
par(mfrow=c(1,3))
terra::plot(r.sg.05, col=rev(heat.colors(64)),
main=paste0("Q05, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.50, col=rev(heat.colors(64)),
main=paste0("Q50, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.95, col=rev(heat.colors(64)),
main=paste0("Q95, SoilGrids250, ",
voi, ", ", depth), range=zlim)
par(mfrow=c(1,1))
# Chunk 13: get.tiles.polaris
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.5 <- terra::rast(file.name)
names(r) <- "p5"
} else {
print("No POLARIS p5 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p50/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.50 <- terra::rast(file.name)
names(r) <- "p50"
} else {
print("No POLARIS p50 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p95/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.95 <- terra::rast(file.name)
names(r) <- "p95"
} else {
print("No POLARIS p95 tile"); stop("Missing input file")
}
# Chunk 14
(aggregation.factor <- res(r.sg.50)/res(r.p.50))
r.p.5 <- terra::aggregate(r.p.5, fact=aggregation.factor, fun="mean")
r.p.50 <- terra::aggregate(r.p.50, fact=aggregation.factor, fun="mean")
r.p.95 <- terra::aggregate(r.p.95, fact=aggregation.factor, fun="mean")
# Chunk 15: mask.sg
r.sg.05 <- terra::resample(r.sg.05, r.p.5, method="near")
r.sg.50 <- terra::resample(r.sg.55, r.p.5, method="near")
r.sg.95 <- terra::resample(r.sg.95, r.p.5, method="near")
zlim = c(floor(min(values(r.sg.05), na.rm=TRUE)),
ceiling(max(values(r.sg.95), na.rm=TRUE)))
par(mfrow=c(1,3))
terra::plot(r.sg.05, col=rev(heat.colors(64)),
main=paste0("Q05, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.50, col=rev(heat.colors(64)),
main=paste0("Q50, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.95, col=rev(heat.colors(64)),
main=paste0("Q95, SoilGrids250, ",
voi, ", ", depth), range=zlim)
par(mfrow=c(1,1))
r.sg.50 <- terra::resample(r.sg.50, r.p.5, method="near")
zlim = c(floor(min(values(r.sg.05), na.rm=TRUE)),
ceiling(max(values(r.sg.95), na.rm=TRUE)))
par(mfrow=c(1,3))
terra::plot(r.sg.05, col=rev(heat.colors(64)),
main=paste0("Q05, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.50, col=rev(heat.colors(64)),
main=paste0("Q50, SoilGrids250, ",
voi, ", ", depth), range=zlim)
terra::plot(r.sg.95, col=rev(heat.colors(64)),
main=paste0("Q95, SoilGrids250, ",
voi, ", ", depth), range=zlim)
par(mfrow=c(1,1))
r.p.05 <- mask(r.p.5, r.sg.05)
r.p.50 <- mask(r.p.50, r.sg.50)
r.p.95 <- mask(r.p.95, r.sg.95)
summary(r.p.05); summary(r.p.95)
summary(r.p.95 - r.p.05)
zlim = c(floor(min(values(r.p.05), na.rm=TRUE)),
ceiling(max(values(r.p.95), na.rm=TRUE)))
par(mfrow=c(1,3))
terra::plot(r.p.05, col=rev(heat.colors(64)),
main=paste0("Q05, POLARIS, ",
voi, ", ", depth), range=zlim)
terra::plot(r.p.50, col=rev(heat.colors(64)),
main=paste0("Q50, POLARIS, ",
voi, ", ", depth), range=zlim)
terra::plot(r.p.95, col=rev(heat.colors(64)),
main=paste0("Q95, POLARIS, ",
voi, ", ", depth), range=zlim)
par(mfrow=c(1,1))
df <- data.frame(property=voi.list.sg,
#"clay"  "silt"  "sand"  "phh2o" "cec"   "soc"   "bdod"  "cfvo"
sg=c("%%","%%","%%","pHx10","mmol(c)/kg","dg/kg","cg/cm3", "cm3/dm3"),  #SG
p=c("%","%", "%","pH","", "log10(%)", "g/cm3", "")  # POLARIS
)
knitr::kable(
df, caption = 'Properties and units of measure',
col.names=c("Property", "SoilGrids","POLARIS"),
booktabs = TRUE)
voi.list.sg
df <- data.frame(property=voi.list,
#"clay"  "silt"  "sand"  "phh2o" "cec"   "soc"   "bdod"  "cfvo"
sg=c("%%","%%","%%","pHx10","mmol(c)/kg","dg/kg","cg/cm3", "cm3/dm3"),  #SG
p=c("%","%", "%","pH","", "log10(%)", "g/cm3", "")  # POLARIS
)
def
df.kernel()
df
voi <- voi.list.sg[voi.n]   # variable of interest, SoilGrids name
voi.list.sg <- c("clay", "silt", "sand", "phh2o", "cec", "soc", "bdod", "cfvo")
voi.n <- 4
voi <- voi.list.sg[voi.n]   # variable of interest, SoilGrids name
depth <- "0-5cm" # "0-5cm", "5-15cm", "15-30cm", "30-60cm", "60-100cm", "100-200cm"
voi_layer_05 <- paste(voi, depth, "Q0.05", sep="_") # layer of interest, 5%
voi_layer_50 <- paste(voi, depth, "Q0.5", sep="_") # layer of interest, 50%
voi_layer_95 <- paste(voi, depth, "Q0.95", sep="_") # layer of interest, 95%
voi.polaris <- voi.list.polaris[match(voi, voi.list)]
depth.polaris <- gsub( "-", "_", strsplit(depth, "cm")[[1]])
voi.polaris <- voi.list.polaris[voi.n]
voi.n <- 4
voi <- voi.list.sg[voi.n]   # variable of interest, SoilGrids name
voi.polaris <- voi.list.polaris[voi.n]
voi.list.sg <- c("clay", "silt", "sand", "phh2o", "cec", "soc", "bdod", "cfvo")
voi.list.polaris <- c("clay", "silt", "sand", "ph", "", "om", "bd", "")
voi.n <- 4
voi <- voi.list.sg[voi.n]   # variable of interest, SoilGrids name
voi.polaris <- voi.list.polaris[voi.n]
df <- data.frame(property=voi.list.sg,
#"clay"  "silt"  "sand"  "phh2o" "cec"   "soc"   "bdod"  "cfvo"
sg=c("%%","%%","%%","pHx10","mmol(c)/kg","dg/kg","cg/cm3", "cm3/dm3"),  #SG
p=c("%","%", "%","pH","", "log10(%)", "g/cm3", "")  # POLARIS
)
knitr::kable(
df, caption = 'Properties and units of measure',
col.names=c("Property", "SoilGrids","POLARIS"),
booktabs = TRUE)
conversions <- data.frame(property=voi.list.sg,
# sg=c("%%","%%","%%","pHx10","mmol(c)/kg","dg/kg","cg/cm3", "cm3/dm3"), #SG
p=c(10,  10, 10,  10, NA, NA, 100, NA)  # POLARIS -- SOM is special case
)
knitr::kable(
conversions, caption = 'Conversion factors, multiply by these to match SoilGrids250',
col.names=c("Property","POLARIS"),
booktabs = TRUE)
(factors <- conversions[match(voi.sg, conversions$property),])
(factors <- conversions[match(voi, conversions$property),])
fact <- as.numeric(factors[3])
fact <- as.numeric(factors[2])
(factors <- conversions[match(voi, conversions$property),])
# POLARIS
fact <- as.numeric(factors[2])
if (!is.na(fact) && (fact != 1)) {
r.p.05 <- r.p.05*fact
r.p.50 <- r.p.50*fact
r.p.95 <- r.p.95*fact
}
if (voi.sg=="soc") {
r.p.05 <- ((10^r.p.05)*0.58*1000)
r.p.50 <- ((10^r.p.50)*0.58*1000)
r.p.95 <- ((10^r.p.95)*0.58*1000)
}
if (voi=="soc") {
r.p.05 <- ((10^r.p.05)*0.58*1000)
r.p.50 <- ((10^r.p.50)*0.58*1000)
r.p.95 <- ((10^r.p.95)*0.58*1000)
}
```{r iqr}
r.iqr.sg <- (r.sg.95 - r.sg.05)
summary(r.iqr.sg)
r.iqr.p <- (r.p.95 - r.p.05)
summary(r.iqr.p)
zlim = c(floor(min(values(r.iqr.sg), values(r.iqr.p), na.rm=TRUE)),
ceiling(max(values(r.iqr.sg), values(r.iqr.p), na.rm=TRUE)))
par(mfrow=c(1,2))
hist(r.iqr.sg, main="SoilGrids250", xlim=zlim)
hist(r.iqr.p, main="POLARIS", xlim=zlim)
par(mfrow=c(1,1))
zlim = c(floor(min(values(r.iqr.sg), values(r.iqr.p), na.rm=TRUE)),
ceiling(max(values(r.iqr.sg), values(r.iqr.p), na.rm=TRUE)))
par(mfrow=c(1,2))
hist(r.iqr.sg, main="SoilGrids250", xlim=zlim, xlab="IQR 5/95%")
hist(r.iqr.p, main="POLARIS", xlim=zlim, xlab="IQR 5/95%")
par(mfrow=c(1,1))
par(mfrow=c(1,2))
terra::plot(r.iqr.sg, col=rev(heat.colors(64)),
main="SoilGrids250 IQR 5/95%", range=zlim)
terra::plot(r.iqr.p, col=rev(heat.colors(64)),
main="POLARIS IQR5/95%", range=zlim)
par(mfrow=c(1,1))
par(mfrow=c(1,2))
terra::plot(r.iqr.sg, col=rev(terrain.colors(64)),
main="SoilGrids250 IQR 5/95%", range=zlim)
terra::plot(r.iqr.p, col=rev(terrain.colors(64)),
main="POLARIS IQR5/95%", range=zlim)
par(mfrow=c(1,1))
par(mfrow=c(1,2))
terra::plot(r.iqr.sg, col=rev(topo.colors(64)),
main="SoilGrids250 IQR 5/95%", range=zlim)
terra::plot(r.iqr.p, col=rev(topo.colors(64)),
main="POLARIS IQR5/95%", range=zlim)
par(mfrow=c(1,1))
r.iqr.diff <- (r.iqr.sg - r.iqr.p)
summary(r.iqr.diff)
hist(r.iqr.diff, main="IQR difference, SG250-POLARIS")
terra::plot(r.iqr.diff, col=rev(bpy.colors(64)),
main="IQR difference  5/95%, SG250-POLARIS")
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p95/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p5/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.5 <- terra::rast(file.name)
names(r.p.95) <- "p5"
} else {
print("No POLARIS p5 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p50/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.50 <- terra::rast(file.name)
names(r.p.50) <- "p50"
} else {
print("No POLARIS p50 tile"); stop("Missing input file")
}
(file.name <- paste0(base.dir.polaris.import, "/",
AOI.dir.prefix, "/",
voi.polaris, "/p95/",
depth.polaris, "/",
AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
r.p.95 <- terra::rast(file.name)
names(r.p.95) <- "p95"
} else {
print("No POLARIS p95 tile"); stop("Missing input file")
}
(cbind(summary(r.p.05), summary(r.p.50), summary(r.p.95)))
?heat.colors
?hcl.colors

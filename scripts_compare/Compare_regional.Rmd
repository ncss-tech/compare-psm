---
title: "Comparing PSM products at regional resolution"
author: "D G Rossiter"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_align: center
    fig_height: 6
    fig_width: 6
    number_section: yes
    theme: spacelab
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center', fig.path = './figs/compare_800m/')
knitr::opts_chunk$set(cache.extra = R.version.string)
```

# Introduction



The [Intermediate-scale gridded soil property and interpretation maps from averaged and aggregated SSURGO and STATSGO data](https://casoilresource.lawr.ucdavis.edu/soil-properties/) from the [California Soil Resource Lab](https://casoilresource.lawr.ucdavis.edu) at UC Davis contains "a variety of soil properties throughout the continental United States ... obtained by aggregating USDA-NCSS soil survey data (SSURGO back-filled with STATSGO where SSURGO is not available) within 800mÂ² grid cells." 

This product is also known as [ISSR-800](https://github.com/ncss-tech/ISSR-800).

The grids were aggregated to 800 x 800 m grid cells:

* Area weighted average of components by map unit
* Area weighted average of all map units within each grid cell

Here we import, limit to a $1 \times 1^\circ$ tile (to match POLARIS) and then compare to POLARIS,  SoilGrids250, which are upscaled in this script to the same resolution. We also compare to the _Soil Properties and Class 100m Grids USA_ (further abbreviated as SPCG100USA) USA-only 100m grids, also upscaled.

These properties can be directly compared:

* pH (SoilGrids  `phh2o`,pH x 10, POLARIS `ph`)
* clay % (SoilGrids `clay` %%, POLARIS `clay` %)
* sand % (SoilGrids `sand` %%, POLARIS `sand` %)


Only compare with SoilGrids (not in POLARIS or SPCG100USA):

* CEC $\mathrm{cmol}\!+ \mathrm{kg}^{-1}$ (SoilGrids `cec` $\mathrm{mmol}\!+ \mathrm{kg}^{-1}$)

* silt % (SoilGrids `silt` %%, POLARIS `silt` %)

Only compare with SoilGrids and POLARIS (not in SPCG100USA):

Others can not be directly compared, because of the additional aggregation method, i.e., thickness weighted average of all horizons, or within a range as indicated. These in ISSR-800:

* bulk density  $g \; {cm}^{-3}$ (SoilGrids `bdod`, $cg \; {cm}^{-3}$, POLARIS `bd`  $g \; {cm}^{-3}$)
* rock fragments 0-25 cm, volume % (SoilGrids `cfvo` volume %%)
* SOM $kg \; {m}^{-2}$, this with depth-weighted average

To compare these the SoilGrids250 depth slices need to be combined as a thickness-weighted average.

SOC stocks in SoilGrids is `ocs` Organic Carbon Stocks, $Mg \; {dam}^{-2}$ ("Tons per hectare"), conversion factor to $kg \; {m}^{-2}$ is to divide by 10. However, these stocks are only for 0-30 cm. In ISSR-800 these are in the same units but as SOM.

ISSR-800 maps can be
[downloaded here](https://casoilresource.lawr.ucdavis.edu/soil-properties/download.php)
as all-48 State GeoTIFF.

ISSR-800 properties have to be provided at the required depth slice. Some were done by NRCS for their own interests (0-5, 0-25, 25-50), and others can be produced by request.

For more on the SoilGrids properties see [here](https://www.isric.org/explore/soilgrids/faq-soilgrids).

For POLARIS properties see [this file](http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/Readme).

# Setup

## Packages

```{r}
library(rgdal)
library(terra)
library(sf)
library(gridExtra)  # arrange multiple plots
# library(knitr)      # for fancy tables
require(xtable)  # format tables for LaTeX
```

## Base directory paths

Set base directories, specific to the local file system. 

1. `base.dir`: This is the location of the processed POLARIS and SoilGrids250 maps from script `SoilGrids250_POLARIS_compare.Rmd`.

2. `base.dir.import`: This is where downloaded large GeoTIFF are located. Because of their size they may be on a separate file system, e.g., removable or networked drive.

```{r}
base.dir <- "/Users/rossiter/ds/"
base.dir.issr8 <- paste0(base.dir, "ISSR8")
base.dir.sg <- paste0(base.dir, "SoilGrids250")
base.dir.polaris <- paste0(base.dir, "POLARIS")
base.dir.psu <- paste0(base.dir, "SPCG100USA")
base.dir.import <- "/Volumes/Pythagoras/ds/"
base.dir.issr8.import <- paste0(base.dir.import, "ISSR8")
base.dir.sg.import <- paste0(base.dir.import, "SoilGrids250")
base.dir.polaris.import <- paste0(base.dir.import, "POLARIS")
base.dir.psu.import <- paste0(base.dir.import, "SPCG100USA")
# GSM tiles must have been imported already and cropped to here
base.dir.gsm <- paste0(base.dir, "GSM_USA")
```



# Property of interest

The SoilGrids250 and POLARIS maps must have previously been downloaded and processed with `SoilGrids250_POLARIS_compare.Rmd` using the same property of interest and depth slice.

The GSM_05 maps maps must have previously been downloaded and processed with `GSM_USA_V05.Rmd` using the same property of interest and depth slice.

Select a property:

```{r}
# property names in various systems
voi.list.issr8 <- c("clay_", "silt_","sand_","ph_", "cec_") # depth slice will be added below
voi.list.sg <- c("clay", "silt", "sand", "phh2o", "cec")
voi.list.polaris <- c("clay", "silt", "sand", "ph", "")  # no CEC
voi.list.psu <- c("clay", "", "sand", "ph_h2o", "")  # no silt or CEC
voi.list.gsm <- c("claytotal_r_g_kg", "silttotal_r_g_kg", "sandtotal_r_g_kg", "ph1to1h2o_r_ions_pHx10", "ecec_r_cmolc_kg")
```

So ISSR8 can be used as a reference for sand, clay, pH for all products, also for CEC for SPCGUSA, also for silt for POLARIS.

Depending on the property, there has to be conversion. 

* pH: Divide the SoilGrids, SPCGUSA100 and GSM05 pHX10 by 10.
* sand, silt, clay: Divide the SoilGrids and GSM05 %% by 10.
* CEC: Divide the SoilGrids  mmol/kg by 10.

```{r}
sg.to.issr8 <- c(10, 10, 10, 10, 10)
psu.to.issr8 <- c(1, 0, 1, 10, 0)    # no silt or CEC
gsm.to.issr8 <- c(10, 10, 10, 10, 1)
```


So all (so far) are division by 10 for SoilGrids and SPCGUSA100 pH; no adjustment for POLARIS.

Select the position in these lists

```{r}
voi <- 1
voi.sg <- voi.list.sg[voi]
voi.issr8 <- voi.list.issr8[voi]
voi.polaris <- voi.list.polaris[voi]
voi.psu <- voi.list.psu[voi]
voi.gsm <- voi.list.gsm[voi]
```

# Depth of interest

Depth slices:

```{r}
depth.list.sg <- c("0-5", "5-15", "15-30", "30-60", "60-100", "100-200")
depth.list.polaris <- gsub("-", "_", depth.list.sg)
depth.list.issr8 <- gsub("-", "", depth.list.sg)
# SPCGUSA100 predicts at points, these must be averaged
depth.list.psu <- c(0, 5, 15, 30, 60, 100, 200)
depth.list.gsm <- c("000_005", "005_015", "015_030", "030_060", "060_100", "100_200")
```

Select the depth slice:

```{r}
depth <- 4
# this is the slice for SoilGrids, POLARIS, ISSR-8; the upper boundary for SPCGUSA100
```

Add depth to ISSR-800 property name:

```{r}
voi.issr8 <- paste0(voi.issr8, depth.list.issr8[depth])
```


# Area of Interest (AOI) {#aoi}

The SoilGrids250 and POLARIS maps must have previously been downloaded and processed with `SoilGrids250_POLARIS_compare.Rmd` using the same $1 \times 1^\circ$  AOI.

We use a $1 \times 1^\circ$ tile, because that is how POLARIS data is served.
Specify the lower-right corner, then compute the upper-right corner 1 degree west and north.

Specify the two corners using WGS84 geographic coordinates:

```{r}
# tile.lrc <- c(-121, 46)  # lower-right corner: Centralia WA
# tile.lrc <- c(-86, 38)  # lower-right corner: southern Indiana
# tile.lrc <- c(-76, 42)   # lower-right corner: central NY
tile.lrc <- c(-77, 35)   # lower-right corner: coastal plain NC
tile.ulc <- c(tile.lrc[1]-1, tile.lrc[2]+1) # upper-left corner
m <- matrix(c(tile.ulc[1],tile.lrc[1],  #ulc
              tile.ulc[2], tile.lrc[2]), nrow=2) #lrc
bb.ll <- st_sfc(st_multipoint(m))
st_crs(bb.ll) <- 4326   # ESPG code for WGS84 long/lat
```

A prefix for directories, to keep AOI results separate.

```{r}
AOI.dir.prefix <- paste0("lat", tile.lrc[2], tile.ulc[2],
                         "_lon", tile.ulc[1], tile.lrc[1])
```

Set up a directory for the products, separated by AOI:

```{r}
dest.dir.issr8 <-  file.path(base.dir.issr8,
                       AOI.dir.prefix)
if (!dir.exists(dest.dir.issr8)) {
   dir.create(dest.dir.issr8,recursive = TRUE)
}
```

Project the bounding box to Goode Interrupted Homolosine (IGH) used by SoilGrids:

```{r}
# convert to Homolosine. Note epsg=152160 is not in PROJ4 database
crs.igh <- '+proj=igh +lat_0=0 +lon_0=0 +datum=WGS84 +units=m +no_defs'
(bb.igh <- st_transform(bb.ll, crs.igh))
(bb.igh <- st_coordinates(bb.igh)[,1:2])
(bb <- as.vector(t(bb.igh)))
```

Project the bounding box to the AEA. This is the CRS used by ISSR-800 and SPCG100USA:

```{r}
crs.aea <- "+proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
(bb.aea <- st_transform(bb.ll, crs.aea))
```

# Import all products

Import and limit to bounding box, and make the units compatible. The following section will compare them.


## ISSR-800 

```{r plot.properties.issr8.import}
r.issr8 <- terra::rast(paste0(base.dir.issr8.import, "/", voi.issr8, ".tif"))
print(r.issr8)
terra::plot(r.issr8, main=paste("ISSR-800;",  main=voi.issr8))
```

This is in a continental Albers Equal Area projection on the GRS80 ellipsoid.

Crop to the bounding box

Make a `terra` `SpatExtent` object from the bounding box and use it to crop.

```{r plot.properties.issr8.crop}
st_bbox(bb.aea)
bb.vect <- as.vector(matrix(st_bbox(bb.aea), nrow=2, byrow=T))
bb.aea.ext <- ext(bb.vect)
r.issr8.crop <- terra::crop(r.issr8, bb.aea.ext)
plot(r.issr8.crop, main=paste("ISSR-800;",  main=voi.issr8))
print(r.issr8.crop)
summary(r.issr8.crop)
# cat(crs(r.issr8.crop))
```

We now have a $1 \times 1^\circ$ tile from ISSR800. Note the NA's can be used as a mask -- these are water areas.

## POLARIS

Get a file that was downloaded in script  `SoilGrids250_POLARIS_compare.Rmd`.

```{r import-polaris-tile}
file.in <- paste0(base.dir.polaris.import, "/",
                  AOI.dir.prefix, "/",
                  voi.polaris,"/mean/",
                  depth.list.polaris[depth], "/",
                  AOI.dir.prefix, ".tif")
if (file.exists(file.in)) {
  r.p <- terra::rast(file.in); print(r.p)
} else {
  print("No corresponding POLARIS tile, property is skipped") # this will fail for CEC
}
```

Resample POLARIS to match ISSR-800:

```{r resample-polaris}
if (exists("r.p")) {
  r.p.aea <- terra::project(r.p, r.issr8.crop, method="bilinear")
  plot(r.p.aea, main=paste("POLARIS;", voi.issr8))
}
```

Note this step has converted from integers to floating-point.

## SoilGrids

Get a tile that was downloaded with script `SoilGrids250_POLARIS_compare.Rmd`. This was placed directly in the local storage.

```{r get-sg}
file.in <- paste0(base.dir.sg, "/",
                  AOI.dir.prefix, "/",
                  voi.sg,"/mean/",
                  depth.list.sg[depth],"cm/SG_",
                  voi.sg,"_",
                  depth.list.sg[depth],
                  "cm_mean.tiff")
if (file.exists(file.in)) {
  r.sg <- terra::rast(file.in); print(r.sg)
} else {
  print("No corresponding SoilGrids250 tile")
  stop("Missing input file")
}
```

The 0 values are masked urban and water. To compare with other grids, convert these to `NA`.

```{r zero-to-na}
r.sg <- terra::classify(r.sg,  matrix(c(0, NA), nrow=1), include.lowest=TRUE)
```


Resample the SoilGrids to match ISSR800. This aggregates from 250 m to 800  m resolution.  Resample into the AEA grid used by ISSR800, and also make units compatible

```{r plot.sg.aea}
r.sg.aea <- terra::project(r.sg, r.issr8.crop)/sg.to.issr8[depth]
plot(r.sg.aea, main=paste("SoilGrids250;", voi.issr8))
```

Note this step has converted from integers to floating-point.

## SPCG100 USA

The slice numbers which will be averaged to match the required slice are the the `depth` and `depth + 1`.


Import the relevant depths, crop, and average through the slice.


```{r in.slices}
filename.in <- paste0(base.dir.psu.import, "/", voi.psu, "_M_sl", depth, "_100m.tif")
if (file.exists(filename.in)) {
  r.psu.top <- terra::rast(filename.in)
} else {
  print("No corresponding SPCG100 property at 0 cm, skipping this property")  # this will fail for CEC
}
filename.in <- paste0(base.dir.psu.import, "/", voi.psu, "_M_sl", depth+1, "_100m.tif")
if (file.exists(filename.in)) {
  r.psu.bottom <- terra::rast(filename.in)
} else {
  print("No corresponding SPCG100 property at 5 cm, skipping this property")  # this will fail for CEC
}
# crop to study area and average the two layers to give 0-5 slice
if (exists("r.psu.top") && exists("r.psu.bottom")) {
  bb.vect <- as.vector(matrix(st_bbox(bb.aea), nrow=2, byrow=T))
  bb.aea.ext <- ext(bb.vect)
  r.psu.crop.top <- terra::crop(r.psu.top, bb.aea.ext)
  r.psu.crop.bottom <- terra::crop(r.psu.bottom, bb.aea.ext)
  r.psu.crop <- ((r.psu.crop.bottom + r.psu.crop.top)/2)
  rm(r.psu.top, r.psu.bottom, r.psu.crop.top, r.psu.crop.bottom)

  # aggregate to 800 m resolution 
  r.psu.aea <- terra::project(r.psu.crop, r.issr8.crop)
  terra::plot(r.psu.aea, main="SPCGUSA100", xlab=voi.issr8)
  
  # and make units compatible
  r.psu.aea <- r.psu.aea/psu.to.issr8[voi]
  
  # destination directory
  dest.dir.psu <-  paste0(base.dir.psu, "/", AOI.dir.prefix, "/",
                          voi.psu, "/mean/sl", depth)
  if (!dir.exists(dest.dir.psu)) {
    dir.create(dest.dir.psu, recursive = TRUE)}
}
```


  
## GSM v0.5

The tile, in its original resolution and CRS, must have been prepared in `GSM_USA_V05.Rmd`.

```{r get-gsm}
file.in <- paste0(base.dir.gsm, "/", AOI.dir.prefix,
                   "/GSM_mu_", voi.gsm, "_", depth.list.gsm[depth], ".tif")
rgdal::GDALinfo(file.in)
if (file.exists(file.in)) {
  r.gsm <- terra::rast(file.in); print(r.gsm)
} else {
  print("No corresponding GSM v0.5 tile")
  stop("Missing input file")
}
terra::plot(r.gsm)
```


Aggregate to 800 m resolution and resample to ISSR8 CRS:

```{r}
r.gsm.aea <- terra::project(r.gsm, r.issr8.crop)
```

Make units compatible:

```{r}
r.gsm.aea <- r.gsm.aea/gsm.to.issr8[voi]
terra::plot(r.gsm.aea, main="GSM v0.5", xlab=voi.issr8)
```

Destination directory for created files:

```{r}
dest.dir.gsm <-  paste0(base.dir.psu, "/", AOI.dir.prefix, "/",
                        voi.psu, "/mean/sl", depth)
if (!dir.exists(dest.dir.psu)) {
  dir.create(dest.dir.psu, recursive = TRUE)}
```

## Save tiles for pattern analysis


Save all of these under a local directory for ISSR-800. These will be used by script `CompareSpatialPatterns.Rmd`.

(Note: Neither `.Rdata` nor `.rds` formats are suitable, since there are internal "promises" which can't be evaluated when read back with `load` or `readRDS`.)

```{r save.tiles}
f <- writeRaster(r.issr8.crop, file=paste0(dest.dir.issr8,"/issr8_tile_aea_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
f <- writeRaster(r.sg.aea, file=paste0(dest.dir.issr8,"/sg_tile_aea_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
if (exists("r.psu.aea")) {
  f <- writeRaster(r.psu.aea, file=paste0(dest.dir.issr8,"/psu_tile_aea_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
}
if (exists("r.p.aea")) {
  f <- writeRaster(r.p.aea, file=paste0(dest.dir.issr8,"/polaris_tile_aea_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
}
if (exists("r.gsm.aea")) {
  f <- writeRaster(r.p.aea, file=paste0(dest.dir.issr8,"/gsm_tile_aea_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
}
```

# Compare

## Mask out common areas

POLARIS predicts in the lakes, for example.


```{r mask.lakes}
r.p.aea <- mask(r.p.aea, r.sg.aea)
```

Mask from POLARIS to get only the Homolosine tile.

```{r}
r.sg.aea <- mask(r.sg.aea, r.p.aea)
r.issr8.crop <- mask(r.issr8.crop, r.p.aea)
r.psu.aea <- mask(r.psu.aea, r.p.aea)
r.gsm.aea <- mask(r.gsm.aea, r.p.aea)
```


## Compute common range for all products

```{r compare.zlim}
zlim <- c(floor(min(values(r.sg.aea)*10, values(r.issr8.crop)*10, na.rm=TRUE)),
          ceiling(max(values(r.sg.aea)*10, values(r.issr8.crop)*10, na.rm=TRUE)))/10
if (exists("r.p.aea")) {
  zlim <- c(floor(min(zlim[1]*10, values(r.p.aea)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(r.p.aea)*10, na.rm=TRUE)))/10
}
if (exists("r.psu.aea")) {
  zlim <- c(floor(min(zlim[1]*10, values(r.psu.aea)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(r.psu.aea)*10, na.rm=TRUE)))/10
}
if (exists("r.gsm.aea")) {
  zlim <- c(floor(min(zlim[1]*10, values(r.gsm.aea)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(r.gsm.aea)*10, na.rm=TRUE)))/10
}
```

## Histograms

The property and depth will be given in the caption, if this is used in a publication.

```{r hist.sg.props, fig.width=12, fig.height=18}
par(mfrow=c(3,2))
hist(r.issr8.crop, main="ISSR-800", xlim=zlim, xlab="")
hist(r.sg.aea, main="SoilGrids250", xlim=zlim, xlab="")
if (exists("r.p.aea")) {
  hist(r.p.aea, main="POLARIS", xlim=zlim, xlab="")
}
if (exists("r.psu.aea")) {
  hist(r.p.aea, main="SPCG100", xlim=zlim, xlab="")
}
if (exists("r.gsm.aea")) {
  hist(r.gsm.aea, main="GSM v0.5", xlim=zlim, xlab="")
}
par(mfrow=c(1,1))
```

## Maps

```{r compare.sg.props, fig.width=12, fig.height=18}
par(mfrow=c(3,2))
terra::plot(r.issr8.crop, range=zlim, main="ISSR-800")
terra::plot(r.sg.aea, range=zlim, main="SoilGrids")
if (exists("r.p.aea")) {
  terra::plot(r.p.aea, main="POLARIS", range=zlim)
}
if (exists("r.p.aea")) {
  terra::plot(r.psu.aea, main="SPCG100", range=zlim)
}
if (exists("r.gsm.aea")) {
  terra::plot(r.gsm.aea, main="GSM v0.5", range=zlim)
}
par(mfrow=c(1,1))
```


# Differences 

## Compute all differences

```{r}
summary(diff.issr8.sg <-  r.issr8.crop - r.sg.aea)
if (exists("r.p.aea")) {
  summary(diff.issr8.p <-  r.issr8.crop - r.p.aea) }
if (exists("r.psu.aea")) {
  summary(diff.issr8.psu <-  r.issr8.crop - r.psu.aea) }
if (exists("r.gsm.aea")) {
  summary(diff.issr8.gsm <-  r.issr8.crop - r.gsm.aea) }
```

## Statistics

```{r warning=FALSE}
stats.compare <- data.frame(PSM_product = "", MD = 0, RMSD = 0, RMSD.Adjusted = 0)
rmse <- function(v1, v2) {
  round(sqrt(mean((v1-v2)^2, na.rm=TRUE)),3)
}
me <- function(v1, v2) { 
  round(mean(v1-v2, na.rm=TRUE), 3)
}
rmse.adj <- function(v1, v2) {   # RMSE adjusted for ME (bias)
  me <- mean(v1-v2, na.rm=TRUE)
  v2.adj <- v2 + me
  round(sqrt(mean((v1-v2.adj)^2, na.rm=TRUE)),3)
}
stats.compare[1, ] <- c("SoilGrids250",
                        me(values(r.issr8.crop),values(r.sg.aea)),
                        rmse(values(r.issr8.crop),values(r.sg.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.sg.aea))
                        )
if (exists("r.p.aea")) {
  stats.compare[2, ] <- c("POLARIS",
                        me(values(r.issr8.crop),values(r.p.aea)),
                        rmse(values(r.issr8.crop),values(r.p.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.p.aea))
                        )
}
if (exists("r.psu.aea")) {
  stats.compare[3, ] <- c("SPCG100",
                        me(values(r.issr8.crop),values(r.psu.aea)),
                        rmse(values(r.issr8.crop),values(r.psu.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.psu.aea))
                        )
}
if (exists("r.gsm.aea")) {
  stats.compare[4, ] <- c("GSM v0.5",
                        me(values(r.issr8.crop),values(r.gsm.aea)),
                        rmse(values(r.issr8.crop),values(r.gsm.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.gsm.aea))
                        )
}
```

```{r}
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
x <- xtable(stats.compare, row.names=FALSE, digits=3)
autoformat(x)
capture.output(print(x, include.rownames=FALSE), 
               file=paste0("./tables/ISSR800_compare_statistics_",
                           AOI.dir.prefix, "_", voi.issr8, "_", depth, ".tex"))
```

## Compute common range for all differences

```{r compare.zlim.diff}
zlim <- c(floor(min(values(diff.issr8.sg)*10, na.rm=TRUE)),
          ceiling(max(values(diff.issr8.sg)*10, na.rm=TRUE)))/10
if (exists("diff.issr8.p")) {
  zlim <- c(floor(min(zlim[1]*10, values(diff.issr8.p)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(diff.issr8.p)*10, na.rm=TRUE)))/10
}
if (exists("diff.issr8.psu")) {
  zlim <- c(floor(min(zlim[1]*10, values(diff.issr8.psu)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(diff.issr8.psu)*10, na.rm=TRUE)))/10
}
if (exists("diff.issr8.gsm")) {
  zlim <- c(floor(min(zlim[1]*10, values(diff.issr8.gsm)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(diff.issr8.gsm)*10, na.rm=TRUE)))/10
}
```

## Histograms

```{r hist.diff, fig.width=15, fig.height=15}
par(mfrow=c(2,2))
hist(diff.issr8.sg, main="Difference ISSR-800 - SG250", xlab="",
     xlim=zlim)
if (exists("r.p.aea")) {
  hist(diff.issr8.p, main="Difference ISSR-800 - POLARIS", xlab="",
     xlim=zlim)
}
if (exists("r.psu.aea")) {
  hist(diff.issr8.psu, main="Difference ISSR-800 - SPCG100", xlab="",
     xlim=zlim)
}
if (exists("r.gsm.aea")) {
  hist(diff.issr8.psu, main="Difference ISSR-800 - GSM v0.5", xlab="",
     xlim=zlim)
}
par(mfrow=c(1,1))
```


## Maps

```{r plot.diff, fig.width=15, fig.height=15}
par(mfrow=c(2,2))
terra::plot(diff.issr8.sg, main="Difference ISSR-800 - SG250", xlab=voi.issr8,
            range=zlim, col=bpy.colors(64))
if (exists("diff.issr8.p")) {
  terra::plot(diff.issr8.p, main="Difference ISSR-800 - POLARIS",
            range=zlim, col=bpy.colors(64))
}
if (exists("diff.issr8.psu")) {
  terra::plot(diff.issr8.psu, main="Difference ISSR-800 - SPCG100",
            range=zlim, col=bpy.colors(64))
}
if (exists("diff.issr8.gsm")) {
  terra::plot(diff.issr8.gsm, main="Difference ISSR-800 - GSM v0.5",
            range=zlim, col=bpy.colors(64))
}
par(mfrow=c(1,1))
```

## Save difference comparison maps

Save these with the same stretch.

Save as GeoTIFF (for use in GIS) and PNG (for printing):

```{r save-sg-issr-diff}
# GeoTIFF for GIS work
f <- writeRaster(diff.issr8.sg, file=paste0(dest.dir.issr8,"/diff_issr8_sg_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
print(f)
# PNG for printing
title <- paste0("Difference ISSR-800 - SG250: ",
                voi.issr8)
png(file = paste0(dest.dir.issr8,"/diff_issr8_sg_",
                  voi.issr8,".png"),
    width=960, height=960)  ## this size for a sharper image, shows all pixels
terra::plot(diff.issr8.sg, col=bpy.colors(64),
            range=zlim, main=title)
dev.off()
```


```{r save-polaris-issr-diff}
if (exists("diff.issr8.p")) {
  f <- writeRaster(diff.issr8.p, file=paste0(dest.dir.issr8,"/diff_issr8_polaris_",
                                     voi.issr8, ".tiff"),
                   overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
                   filetype="GTiff")
  print(f)
  title <- paste0("Difference ISSR-800 - POLARIS: ",
                  voi.issr8)
  png(file = paste0(dest.dir.issr8,"/diff_issr8_polaris_",
                    voi.issr8,".png"),
      width=960, height=960)  ## this size for a sharper image
  terra::plot(diff.issr8.p, col=bpy.colors(64),
            range=zlim, main=title)
  dev.off()
}
```


```{r save-spcgusa-issr-diff}
if (exists("diff.issr8.psu")) {
  f <- writeRaster(diff.issr8.psu, file=paste0(dest.dir.issr8, "/diff_issr8_spcgusa_",
                                     voi.issr8, ".tiff"),
                   overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
                   filetype="GTiff")
  print(f)
  title <- paste0("Difference ISSR-800 - SPCGUSA1-00: ",
                  voi.issr8)
  png(file = paste0(dest.dir.psu, "/diff_issr8_spcgusa_",
                    voi.issr8,".png"),
      width=960, height=960)  ## this size for a sharper image
  terra::plot(diff.issr8.psu, col=bpy.colors(64),
            range=zlim, main=title)
  dev.off()
}
```

```{r save-gsm-issr-diff}
if (exists("diff.issr8.gsm")) {
  f <- writeRaster(diff.issr8.psu, file=paste0(dest.dir.issr8, "/diff_issr8_gsm_",
                                     voi.issr8, ".tiff"),
                   overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
                   filetype="GTiff")
  print(f)
  title <- paste0("Difference ISSR-800 - GSM v0.5: ",
                  voi.issr8)
  png(file = paste0(dest.dir.psu, "/diff_issr8_gsm_",
                    voi.issr8,".png"),
      width=960, height=960)  ## this size for a sharper image
  terra::plot(diff.issr8.psu, col=bpy.colors(64),
            range=zlim, main=title)
  dev.off()
}
```

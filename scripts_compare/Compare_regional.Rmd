---
title: "Comparing PSM products at regional resolution"
author: "D G Rossiter"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_align: center
    fig_height: 6
    fig_width: 6
    number_section: yes
    theme: spacelab
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      fig.path = './figs/compare_800m/')
knitr::opts_chunk$set(cache.extra = R.version.string)
```

# Introduction

This script compares PSM products at 800m grid resolution.
We consider this an appropriate resolution for regional studies.

The PSM products must have been previously imported and restricted to the same area of interest (AOI), typically $1 \times 1^\circ$, to the locations indicated in the directory list.

These properties can be directly compared:

* pH (SoilGrids  `phh2o`,pH x 10, POLARIS `ph`)
* clay % (SoilGrids `clay` %%, POLARIS `clay` %)
* sand % (SoilGrids `sand` %%, POLARIS `sand` %)

Only compare with SoilGrids (not in POLARIS or SPCG100USA):

* CEC $\mathrm{cmol}\!+ \mathrm{kg}^{-1}$ (SoilGrids `cec` $\mathrm{mmol}\!+ \mathrm{kg}^{-1}$)

* silt % (SoilGrids `silt` %%, POLARIS `silt` %)

Only compare with SoilGrids and POLARIS (not in SPCG100USA):

Others can not be directly compared, because of the additional aggregation method, i.e., thickness weighted average of all horizons, or within a range as indicated. These in ISSR-800:

* bulk density  $g \; {cm}^{-3}$ (SoilGrids `bdod`, $cg \; {cm}^{-3}$, POLARIS `bd`  $g \; {cm}^{-3}$)
* rock fragments 0-25 cm, volume % (SoilGrids `cfvo` volume %%)
* SOM $kg \; {m}^{-2}$, this with depth-weighted average

To compare these the SoilGrids250 depth slices need to be combined as a thickness-weighted average.

SOC stocks in SoilGrids is `ocs` Organic Carbon Stocks, $Mg \; {dam}^{-2}$ ("Tons per hectare"), conversion factor to $kg \; {m}^{-2}$ is to divide by 10. However, these stocks are only for 0-30 cm. In ISSR-800 these are in the same units but as SOM.

For more on the SoilGrids properties see [here](https://www.isric.org/explore/soilgrids/faq-soilgrids).

For POLARIS properties see [this file](http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/Readme).

# Setup

## Packages

```{r}
library(rgdal)
library(terra)
library(sf)
library(gridExtra)  # arrange multiple plots
# library(knitr)      # for fancy tables
require(xtable)  # format tables for LaTeX
```

## Base directory paths

Set base directories, specific to the local file system. 

1. `base.dir`: This is the location of the PSM tiles that have been cropped to an AOI.

2. `base.dir.import`: This is where downloaded large GeoTIFF are located. Because of their size they may be on a separate file system, e.g., removable or networked drive. In this script this location is only used for POLARIS, since they are imported directly as $1 \times 1^\circ$ tiles.

```{r}
base.dir <- "/Users/rossiter/ds/"
base.dir.gsm <- paste0(base.dir, "GSM_USA")
base.dir.issr8 <- paste0(base.dir, "ISSR8")
base.dir.sg <- paste0(base.dir, "SoilGrids250")
base.dir.polaris <- paste0(base.dir, "POLARIS")
base.dir.psu <- paste0(base.dir, "SPCG100USA")
base.dir.landgis <- paste0(base.dir, "LandGIS")
# POLARIS tiles are large, they were imported to the "raw import" volume
base.dir.import <- "/Volumes/Pythagoras/ds/"
base.dir.polaris.import <- paste0(base.dir.import, "POLARIS")
```

# Property of interest

Property names in various systems:


```{r}
# clay, silt, sand, pH, CEC, SOC, bulk density, coarse fragments
voi.list.sg <- c("clay", "silt", "sand", "phh2o", "cec", "soc", "bdod")
voi.list.gsm <- c("claytotal_r_g_kg", "silttotal_r_g_kg", "sandtotal_r_g_kg", 
                  "ph1to1h2o_r_ions_pHx10", "ecec_r_cmolc_kg", "soc_r_mr_g_gF", "", "")
voi.list.issr8 <- c("clay", "silt","sand","ph", "cec", "", "", "")
voi.list.polaris <- c("clay", "silt", "sand", "ph", "", "om", "bd", "") 
voi.list.psu <- c("clay", "", "sand", "ph_h2o", "", "soc", "bd", "")
voi.list.landgis <- c("clay.wfraction_usda.3a1a1a",
                      "silt.wfraction_usda.3a1a1a",
                      "sand.wfraction_usda.3a1a1a",
                      "ph.h2o_usda.4c1a2a",
                      "",
                      "organic.carbon_usda.6a1c",
                      "bulkdens.fineearth_usda.4a1h",
                      "coarsefrag.vfraction_usda_3b1")
```


Select the position in these lists

```{r}
voi <- 1
voi.sg <- voi.list.sg[voi]
voi.issr8 <- voi.list.issr8[voi]
voi.polaris <- voi.list.polaris[voi]
voi.psu <- voi.list.psu[voi]
voi.gsm <- voi.list.gsm[voi]
```

# Depth of interest

Depth slices:

```{r}
depth.list.sg <- c("0-5", "5-15", "15-30", "30-60", "60-100", "100-200")
# SPCGUSA100 predicts at points, these were averaged to GSM slices during import
# --- these have the SG names
# LandGIS predicts at points, these were averaged to GSM slices during import
# --- these have the SG names
depth.list.polaris <- gsub("-", "_", depth.list.sg)
depth.list.issr8 <- gsub("-", "", depth.list.sg)
depth.list.gsm <- c("000_005", "005_015", "015_030", "030_060", "060_100", "100_200")
```

Select the depth slice:

```{r}
depth <- 4
```

Add depth to ISSR-800 property name:

```{r}
voi.issr8 <- paste0(voi.issr8, "_", depth.list.issr8[depth])
```


# Area of Interest (AOI) {#aoi}

We use a $1 \times 1^\circ$ tile, because that is how POLARIS data is served.
Specify the lower-right corner, then compute the upper-right corner 1 degree west and north.

Specify the two corners using WGS84 geographic coordinates:

Specify the lower-right corner:

```{r lrc}
tile.lrc <- c(-76, 42)   # lower-right corner
tile.size <- 1
```

Compute the upper-left coner:

```{r ulc}
tile.ulc <- c(tile.lrc[1]-tile.size, tile.lrc[2]+tile.size) # upper-left corner
```

A prefix for directories, to keep AOI results separate.

```{r}
AOI.dir.prefix <- paste0("lat", tile.lrc[2], tile.ulc[2],
                         "_lon", tile.ulc[1], tile.lrc[1])
```


A prefix for directories, to keep AOI results separate.

```{r}
AOI.dir.prefix <- paste0("lat", tile.lrc[2], tile.ulc[2],
                         "_lon", tile.ulc[1], tile.lrc[1])
```

Set up a directory for the products, separated by AOI:

```{r}
dest.dir.issr8 <-  file.path(base.dir.issr8,
                       AOI.dir.prefix)
if (!dir.exists(dest.dir.issr8)) {
   dir.create(dest.dir.issr8,recursive = TRUE)
}
```

Bounding box:

```{r bbox.4326}
m <- matrix(c(tile.ulc[1],tile.lrc[1],  #ulc
              tile.ulc[2], tile.lrc[2]), nrow=2) #lrc
bb.ll <- st_sfc(st_multipoint(m))
st_crs(bb.ll) <- 4326   # ESPG code for WGS84 long/lat
```

Project the bounding box to Goode Interrupted Homolosine (IGH) used by SoilGrids:

```{r bbox.igh}
# convert to Homolosine. Note epsg=152160 is not in PROJ4 database
crs.igh <- '+proj=igh +lat_0=0 +lon_0=0 +datum=WGS84 +units=m +no_defs'
(bb.igh <- st_transform(bb.ll, crs.igh))
(bb.igh <- st_coordinates(bb.igh)[,1:2])
(bb <- as.vector(t(bb.igh)))
```

Project the bounding box to the AEA. This is the CRS used by ISSR-800 and SPCG100USA:

```{r bbox.aea}
crs.aea <- "+proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
(bb.aea <- st_transform(bb.ll, crs.aea))
```

# Products to compare


Load the tiles in their native CRS, as processed in the import scripts.

## GSM

```{r get.tiles.gsm}
# GSM
src.dir <-  paste0(base.dir.gsm ,"/", AOI.dir.prefix)
voi.depth.name <- paste0(voi.gsm, "_", depth.list.gsm[depth])
(file.name <- paste0(src.dir, "/GSM_mu_", voi.depth.name, ".tif"))
file.exists(file.name)
if (file.exists(file.name)) {
  r.gsm <- terra::rast(file.name)
  names(r.gsm) <- "GSMv0.5"
  print(r.gsm)
}
```

## SoilGrids250

```{r get.tiles.sg}
# SoilGrids250 -- only the mean prediction in this script
# Use the EPSG:4326 version
src.dir <-  paste0(base.dir.sg ,"/", 
                   AOI.dir.prefix, "/", 
                   voi.sg, "/mean/",
                   depth.list.sg[depth], "cm")
(voi.depth.name <- paste0(voi.sg, "_", depth.list.sg[depth], "cm_mean_4326"))
(file.name <- paste0(src.dir, "/", voi.depth.name, '.tif'))
if (file.exists(file.name)) {
  r.sg <- terra::rast(file.name)
  names(r.sg) <- "SoilGrids250"
  print(r.sg)
}
```

## SPCG100USA

```{r get.tiles.psu}
# SPCG100USA
src.dir <-  paste0(base.dir.psu ,"/", AOI.dir.prefix)
(file.name <- paste0(src.dir, "/", voi.psu, "_", depth.list.sg[depth], '.tif'))
if (file.exists(file.name)) {
  r.psu <- terra::rast(file.name)
  names(r.psu) <- "spcg100usa"
  print(r.psu)
}
```

## POLARIS

```{r get.tiles.polaris}
# POLARIS -- only the mean prediction in this script
(file.name <- paste0(base.dir.polaris.import, "/",
                     AOI.dir.prefix, "/",
                     voi.list.polaris[voi], "/mean/",
                     depth.list.polaris[depth], "/",
                     AOI.dir.prefix, ".tif"))
if (file.exists(file.name)) {
  r.p <- terra::rast(file.name)
  names(r.p) <- "polaris"
  print(r.p)
}
```

## LandGIS

```{r get.tiles.landgis}
# LandGIS -- only the mean prediction in this script
(file.name <- paste0(base.dir.landgis, "/",
                     AOI.dir.prefix, "/",
                     voi.list.landgis[voi], "_",
                     depth.list.sg[depth],
                     ".tif"))
if (file.exists(file.name)) {
  r.landgis <- terra::rast(file.name)
  names(r.landgis) <- "landgis"
  print(r.landgis)
}
```

## ISSR-800


```{r get.tiles.issr8}
(file.name <- paste0(base.dir.issr8, "/",
                     AOI.dir.prefix, "/",
                     voi.list.issr8[voi], "_",
                     depth.list.issr8[depth],
                     ".tif"))
if (file.exists(file.name)) {
  r.issr8 <- terra::rast(file.name)
  names(r.issr8) <- "ISSR-800"
  print(r.issr8)
}
```

# Make the units compatible

Depending on the property, data in some coverages need to be converted to the units used in SoilGrids250; we choose this as the base; note these are integers. Here are the units:

```{r show.conversions}
df <- data.frame(list=voi.list.sg, 
                 sg=c("%%","%%","%%","pHx10","mmol(c)/kg",    "dg/kg",   "cg/cm3"),  #SG
                 p=c("%",  "%", "%",   "pH",          "", "log10(%)",    "g/cm3"),  # POLARIS
                 gsm=c("%%","%%","%%","pHx10","cmol(c)/kg",     "g/gF",    "Mg/m3"),  # GSM
                 spcg=c("%",  "%", "%",   "pH",          "",        "%",    "g/cm3"),  # SPCG100USA
                 lgis=c(  "%","%", "%","pHx10",          "",    "5g/Kg", "10 kg/m3"),  # LandGIS
                 issr=c(  "%","%", "%",   "pH","cmol(+)/kg",         "",    "g/cm3")  # ISSR-800
                 )
knitr::kable(
  df, caption = 'Properties and units of measure',
  col.names=c("Property","SoilGrids","POLARIS","GlobalSoilMap", "SPCG100USA", "LandGIS", "ISSR-800"),
  booktabs = TRUE)
```  

Make a matrix with the conversions to SoilGrids250 units.

```{r make.conversion.matrix}
#### ** TBC
```

Convert units as necessary:

```{r convert}
#### ** TBC
```

Note that SOC for POLARIS is a special case, because of the log10-scale, and because it is SOM, not SOC. Use the conventional conversion factor 0.58 = 1/1.724138.

```{r polaris.soc}
if (voi.polaris=="om") {
  r.p <- ((10^r.p)*0.58*1000) 
}
```

<!-- To here  -->

# Make all maps cover the same area

POLARIS predicts in the lakes, for example.

```{r mask.lakes}
r.p.aea <- mask(r.p.aea, r.sg.aea)
```

Mask from POLARIS to get only the Homolosine tile.

```{r}
r.sg.aea <- mask(r.sg.aea, r.p.aea)
r.issr8.crop <- mask(r.issr8.crop, r.p.aea)
r.psu.aea <- mask(r.psu.aea, r.p.aea)
r.gsm.aea <- mask(r.gsm.aea, r.p.aea)
```

# Compare

## Compute common range for all products

```{r compare.zlim}
zlim <- c(floor(min(values(r.sg.aea)*10, values(r.issr8.crop)*10, na.rm=TRUE)),
          ceiling(max(values(r.sg.aea)*10, values(r.issr8.crop)*10, na.rm=TRUE)))/10
if (exists("r.p.aea")) {
  zlim <- c(floor(min(zlim[1]*10, values(r.p.aea)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(r.p.aea)*10, na.rm=TRUE)))/10
}
if (exists("r.psu.aea")) {
  zlim <- c(floor(min(zlim[1]*10, values(r.psu.aea)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(r.psu.aea)*10, na.rm=TRUE)))/10
}
if (exists("r.gsm.aea")) {
  zlim <- c(floor(min(zlim[1]*10, values(r.gsm.aea)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(r.gsm.aea)*10, na.rm=TRUE)))/10
}
```

## Histograms

The property and depth will be given in the caption, if this is used in a publication.

```{r hist.sg.props, fig.width=12, fig.height=18}
par(mfrow=c(3,2))
hist(r.issr8.crop, main="ISSR-800", xlim=zlim, xlab="")
hist(r.sg.aea, main="SoilGrids250", xlim=zlim, xlab="")
if (exists("r.p.aea")) {
  hist(r.p.aea, main="POLARIS", xlim=zlim, xlab="")
}
if (exists("r.psu.aea")) {
  hist(r.p.aea, main="SPCG100", xlim=zlim, xlab="")
}
if (exists("r.gsm.aea")) {
  hist(r.gsm.aea, main="GSM v0.5", xlim=zlim, xlab="")
}
par(mfrow=c(1,1))
```

## Maps

```{r compare.sg.props, fig.width=12, fig.height=18}
par(mfrow=c(3,2))
terra::plot(r.issr8.crop, range=zlim, main="ISSR-800")
terra::plot(r.sg.aea, range=zlim, main="SoilGrids")
if (exists("r.p.aea")) {
  terra::plot(r.p.aea, main="POLARIS", range=zlim)
}
if (exists("r.p.aea")) {
  terra::plot(r.psu.aea, main="SPCG100", range=zlim)
}
if (exists("r.gsm.aea")) {
  terra::plot(r.gsm.aea, main="GSM v0.5", range=zlim)
}
par(mfrow=c(1,1))
```


# Differences 

## Compute all differences

```{r}
summary(diff.issr8.sg <-  r.issr8.crop - r.sg.aea)
if (exists("r.p.aea")) {
  summary(diff.issr8.p <-  r.issr8.crop - r.p.aea) }
if (exists("r.psu.aea")) {
  summary(diff.issr8.psu <-  r.issr8.crop - r.psu.aea) }
if (exists("r.gsm.aea")) {
  summary(diff.issr8.gsm <-  r.issr8.crop - r.gsm.aea) }
```

## Statistics

```{r warning=FALSE}
stats.compare <- data.frame(PSM_product = "", MD = 0, RMSD = 0, RMSD.Adjusted = 0)
rmse <- function(v1, v2) {
  round(sqrt(mean((v1-v2)^2, na.rm=TRUE)),3)
}
me <- function(v1, v2) { 
  round(mean(v1-v2, na.rm=TRUE), 3)
}
rmse.adj <- function(v1, v2) {   # RMSE adjusted for ME (bias)
  me <- mean(v1-v2, na.rm=TRUE)
  v2.adj <- v2 + me
  round(sqrt(mean((v1-v2.adj)^2, na.rm=TRUE)),3)
}
stats.compare[1, ] <- c("SoilGrids250",
                        me(values(r.issr8.crop),values(r.sg.aea)),
                        rmse(values(r.issr8.crop),values(r.sg.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.sg.aea))
                        )
if (exists("r.p.aea")) {
  stats.compare[2, ] <- c("POLARIS",
                        me(values(r.issr8.crop),values(r.p.aea)),
                        rmse(values(r.issr8.crop),values(r.p.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.p.aea))
                        )
}
if (exists("r.psu.aea")) {
  stats.compare[3, ] <- c("SPCG100",
                        me(values(r.issr8.crop),values(r.psu.aea)),
                        rmse(values(r.issr8.crop),values(r.psu.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.psu.aea))
                        )
}
if (exists("r.gsm.aea")) {
  stats.compare[4, ] <- c("GSM v0.5",
                        me(values(r.issr8.crop),values(r.gsm.aea)),
                        rmse(values(r.issr8.crop),values(r.gsm.aea)),
                        rmse.adj(values(r.issr8.crop),values(r.gsm.aea))
                        )
}
```

```{r}
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
x <- xtable(stats.compare, row.names=FALSE, digits=3)
autoformat(x)
capture.output(print(x, include.rownames=FALSE), 
               file=paste0("./tables/ISSR800_compare_statistics_",
                           AOI.dir.prefix, "_", voi.issr8, "_", depth, ".tex"))
```

## Compute common range for all differences

```{r compare.zlim.diff}
zlim <- c(floor(min(values(diff.issr8.sg)*10, na.rm=TRUE)),
          ceiling(max(values(diff.issr8.sg)*10, na.rm=TRUE)))/10
if (exists("diff.issr8.p")) {
  zlim <- c(floor(min(zlim[1]*10, values(diff.issr8.p)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(diff.issr8.p)*10, na.rm=TRUE)))/10
}
if (exists("diff.issr8.psu")) {
  zlim <- c(floor(min(zlim[1]*10, values(diff.issr8.psu)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(diff.issr8.psu)*10, na.rm=TRUE)))/10
}
if (exists("diff.issr8.gsm")) {
  zlim <- c(floor(min(zlim[1]*10, values(diff.issr8.gsm)*10, na.rm=TRUE)),
            ceiling(max(zlim[2]*10, values(diff.issr8.gsm)*10, na.rm=TRUE)))/10
}
```

## Histograms

```{r hist.diff, fig.width=15, fig.height=15}
par(mfrow=c(2,2))
hist(diff.issr8.sg, main="Difference ISSR-800 - SG250", xlab="",
     xlim=zlim)
if (exists("r.p.aea")) {
  hist(diff.issr8.p, main="Difference ISSR-800 - POLARIS", xlab="",
     xlim=zlim)
}
if (exists("r.psu.aea")) {
  hist(diff.issr8.psu, main="Difference ISSR-800 - SPCG100", xlab="",
     xlim=zlim)
}
if (exists("r.gsm.aea")) {
  hist(diff.issr8.psu, main="Difference ISSR-800 - GSM v0.5", xlab="",
     xlim=zlim)
}
par(mfrow=c(1,1))
```


## Maps

```{r plot.diff, fig.width=15, fig.height=15}
par(mfrow=c(2,2))
terra::plot(diff.issr8.sg, main="Difference ISSR-800 - SG250", xlab=voi.issr8,
            range=zlim, col=bpy.colors(64))
if (exists("diff.issr8.p")) {
  terra::plot(diff.issr8.p, main="Difference ISSR-800 - POLARIS",
            range=zlim, col=bpy.colors(64))
}
if (exists("diff.issr8.psu")) {
  terra::plot(diff.issr8.psu, main="Difference ISSR-800 - SPCG100",
            range=zlim, col=bpy.colors(64))
}
if (exists("diff.issr8.gsm")) {
  terra::plot(diff.issr8.gsm, main="Difference ISSR-800 - GSM v0.5",
            range=zlim, col=bpy.colors(64))
}
par(mfrow=c(1,1))
```

## Save difference comparison maps

Save these with the same stretch.

Save as GeoTIFF (for use in GIS) and PNG (for printing):

```{r save-sg-issr-diff}
# GeoTIFF for GIS work
f <- writeRaster(diff.issr8.sg, file=paste0(dest.dir.issr8,"/diff_issr8_sg_",
                              voi.issr8, ".tiff"),
            overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
            filetype="GTiff")
print(f)
# PNG for printing
title <- paste0("Difference ISSR-800 - SG250: ",
                voi.issr8)
png(file = paste0(dest.dir.issr8,"/diff_issr8_sg_",
                  voi.issr8,".png"),
    width=960, height=960)  ## this size for a sharper image, shows all pixels
terra::plot(diff.issr8.sg, col=bpy.colors(64),
            range=zlim, main=title)
dev.off()
```


```{r save-polaris-issr-diff}
if (exists("diff.issr8.p")) {
  f <- writeRaster(diff.issr8.p, file=paste0(dest.dir.issr8,"/diff_issr8_polaris_",
                                     voi.issr8, ".tiff"),
                   overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
                   filetype="GTiff")
  print(f)
  title <- paste0("Difference ISSR-800 - POLARIS: ",
                  voi.issr8)
  png(file = paste0(dest.dir.issr8,"/diff_issr8_polaris_",
                    voi.issr8,".png"),
      width=960, height=960)  ## this size for a sharper image
  terra::plot(diff.issr8.p, col=bpy.colors(64),
            range=zlim, main=title)
  dev.off()
}
```


```{r save-spcgusa-issr-diff}
if (exists("diff.issr8.psu")) {
  f <- writeRaster(diff.issr8.psu, file=paste0(dest.dir.issr8, "/diff_issr8_spcgusa_",
                                     voi.issr8, ".tiff"),
                   overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
                   filetype="GTiff")
  print(f)
  title <- paste0("Difference ISSR-800 - SPCGUSA1-00: ",
                  voi.issr8)
  png(file = paste0(dest.dir.psu, "/diff_issr8_spcgusa_",
                    voi.issr8,".png"),
      width=960, height=960)  ## this size for a sharper image
  terra::plot(diff.issr8.psu, col=bpy.colors(64),
            range=zlim, main=title)
  dev.off()
}
```

```{r save-gsm-issr-diff}
if (exists("diff.issr8.gsm")) {
  f <- writeRaster(diff.issr8.psu, file=paste0(dest.dir.issr8, "/diff_issr8_gsm_",
                                     voi.issr8, ".tiff"),
                   overwrite=TRUE, wopt=list(gdal=c("TFW=YES")),
                   filetype="GTiff")
  print(f)
  title <- paste0("Difference ISSR-800 - GSM v0.5: ",
                  voi.issr8)
  png(file = paste0(dest.dir.psu, "/diff_issr8_gsm_",
                    voi.issr8,".png"),
      width=960, height=960)  ## this size for a sharper image
  terra::plot(diff.issr8.psu, col=bpy.colors(64),
            range=zlim, main=title)
  dev.off()
}
```
